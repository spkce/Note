# IP
IP指网际互连协议，Internet Protocol的缩写是TCP/IP体系中的网络层协议。
IP协议主要作用是提供一种能力，将数据从A主机传送到B主机的能力。

# IP协议头
```
0                         15 16                         31
+------+-------+------------+---------------------------+
｜ ver ｜length｜    TOS     ｜        数据包长度          ｜
+---------------------------+------+--------------------+
｜           标识id          ｜ 标志 ｜      片偏移         ｜
+--------------+------------+---------------------------+
｜     TTL     ｜   传输协议  ｜       首部校验和           ｜
+-------------------------------------------------------+
｜                         源IP                         ｜
+-------------------------------------------------------+
｜                        目的IP                         ｜
+-------------------------------------------------------+
｜                     选项（如果有）                      ｜
+-------------------------------------------------------+
```
**ver（4bit）**：指定IP协议的版本（IPv4/IPv6），对于IPv4来说，就是4。
length（4bit）：IP首部长度
**TOS（8bit）**：Type Of Service 服务类型 。位优先权字段(已经弃用), 4位TOS字段, 和1位保留字段(必须置为0)。4位TOS分别表示:：最小延时, 最大吞吐量, 最高可靠性, 最小成本. 这四者相互冲突, 只能选择一个. 对于ssh/telnet这样的应用程序, 最小延时比较重要; 对于ftp这样的程序, 最大吞吐量比较重要。
**数据包长度（16bit）**：IP报文（IP报头+有效载荷）的总长度，用于将各个IP报文进行分离。 
服务类型：3位优先权字段（已经弃用），4位TOS字段，和1位保留字段（必须置为0）。4位TOS分别表示，最小延时，最大吞吐量，最高可靠性，最小成本。
**标识（16bit）**：唯一的标识主机发送的报文. 如果IP报文在数据链路层被分片了, 那么每一个片里面的这个id都是相同的。
**标志（3bit）**：第一位保留. 第二位置为1表示禁止分片, 这时候如果报文长度超过MTU, IP模块就会丢弃报文. 第三位表示"更多分片", 如果分片了的话,最后一个分片置为0, 其他是1. 类似于一个结束标记.
**片偏移（13bit）**：framegament offset。分片相对于原始IP报文开始处的偏移. 其实就是在表示当前分片在原报文中处在哪个位置. 实际偏移的字节数是这个值 * 8 得到的. 因此, 除了最后一个报文之外, 其他报文的长度必须是8的整数倍(否则报文就不连续了).
**TTL（13bit）**：生存时间（Time To Live）。数据报到达目的地的最大报文跳数. 一般是64. 每次经过一个路由, TTL-= 1, 一直减到0还没到达, 那么就丢弃了. 这个字段主要是用来防止出现路由循环。
**传输协议（8bit）**：表示上层协议的类型。如tcp/udp

**首部校验和（16bit）**：对头部每个16bit进行二进制反码求和。IP不对负载数据校验
**源IP（32bit）**：表示发送端所对应的IP地址。
**目的IP（32bit）**：表示接收端所对应的IP地址。
**选项字段(不定长, 最多40字节)**：时间戳、记录路由等。时间戳选项用于记录数据包经过的时间，而记录路由选项用于记录数据包经过的路径‌。

# IP的分片
当遇到 IP 数据包大于数据链路 MTU 时，往往无法直接发送出去，主机或路由器就会对 IP 数据包进行分片处理。
经过分片后的 IP 数据，只会在目标主机上进行重组，中途经过路由器时不会进行重组。

# 路径MTU发现

1. 发送端主机发送 IP 数据包时将其头部的分片禁止标志位设置为 1 。根据这个标志位，途中的路由器即使收到需要分片的大包，也不会分片，而是直接将包丢弃。之后通过一个 ICMP 不可达消息将数据链路上 MTU 值给发送端主机。
2. 发送端主机根据收到的 MTU 值对数据包进行分片处理，再把 IP 数据包发送给相同的目的主机。如此重复，直到数据包被发送到目标主机为止没有再收到任何 ICMP ，就认为最后一次 ICMP 所通知的 MTU 即是一个合适的 MTU 值。MTU 值至少可以缓存约 10 分钟
在这 10 分钟内使用刚得到的 MTU ，过了 10 分钟后就重新做一次路径 MTU 发现。

TCP的情况下，根据路径 MTU 的大小计算出最大段长度（ MSS ），然后再根据这些信息进行数据包的发送。因此，在 TCP中如果使用路径 MTU 发现， IP层则不会再分片。

# 路由器三层转发原理
路由器有多个端口，分别连接不同的数据链路。它通过识别目的 IP 地址的网络号，再根据路由表进行转发，路由表中有匹配的路由条目才会转发，无匹配的路由条目则直接丢弃。路由条目既可以手动设置静态路由，也可以通过路由协议自动生成动态路由。
当一台路由器收到一个数据包时，会执行如下步骤：
1. 对数据包进行解封装。
通过解封装，查看网络层头部信息的目的 IP 地址。
2. 在路由表中查找匹配的路由条目。
查找匹配的路由条目，就需要将数据包的目的 IP 地址与各个路由条目的网段地址先进行二进制与（ AND ）运算，再将运算结果与路由条目的网段地址进行比较，若一致则该条目与目的 IP 地址相匹配。最后，与所有路由条目完成运算和比较，可得到一条或多条相匹配的路由条目。也可能没有匹配的路由条目，那么丢弃数据包。

查找路由条目流程
 从多个匹配项中选择掩码最长的路由条目。如果路由表中有多条路由条目都匹配数据包的目的 IP 地址，则路由器会选择掩码长度最长的路由条目，这种匹配方式称为最长匹配原则。例如：10.1.3.10 的网络地址与 10.1.3.0/16 和 10.1.3.0/24 两项都匹配，这时应该选择匹配度最长的 10.1.3.0/24 。
