# ICMP 
ICMP 协议 全称 : 网际控制报文协议 ;
ICMP 报文 属于 IP 数据报 的 数据部分 

# ICMP 报文结构
```
0                         15 16                         31
+--------------+------------+---------------------------+
｜     类型     ｜    代码    ｜          校验和           ｜
+---------------------------+---------------------------+
｜                 这4字节取决于ICMP报文类型               ｜
+-------------------------------------------------------+
｜                        数据部分                       ｜
+-------------------------------------------------------+
```
‌报文头部‌：
‌类型（Type）‌：占8位，用于说明ICMP报文的作用及格式。ICMP报文主要分为两大类，即ICMP差错报告报文和ICMP询问报文。
‌代码（Code）‌：占8位，用于详细说明某种ICMP报文的类型。它和类型字段一起决定了ICMP报文的种类。
‌‌检验和（Checksum）‌：占16位，用于校验报文在整个传输中是否存在错误。其计算方法和IP头部检验和的计算方法一样。


ICMP报文种类 | 类型值 | 报文类型
---------|----------|---------
 差错报告报文 | 3 | 重点不可达
 差错报告报文 | 11 | 时间超时
 差错报告报文 | 12 | 参数问题
 差错报告报文 | 5 | 改变路由
 差错报告报文 | 8或0 | 回送echo请求或回答
 差错报告报文 | 13或14 | 时间戳请求或回答

（1）终点不可达：当路由器或主机不能交付数据报时就向源点发送终点不可达报文。
（2）时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时就把已收到的数据报片都丢弃，并向源点发送时间超过报文。
（3）参数问题：当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
（4）改变路由(重定向)：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。也就是说，找到了更好的路由。


### ICMP 差错报告报文中的数据字段都具有同样的格式

```
                           +-----------------+----------+--------------+
       收到的ip报文         ｜   IP数据报首部   ｜  8 字节  ｜  ip数据内容  ｜
                           +-----------------+----------+--------------+

        +------------------+-----------------+----------+
        ｜  ICMP前 8 字节   ｜   IP数据报首部   ｜  8 字节  ｜
+-------------------------------------------------------+
｜ip首部 ｜            ICMP 差错报告报文                   ｜
+-------------------------------------------------------+
```

  把收到的需要进行差错报告的 IP 数据报的首部和数据字段的前 8 个字节提取出来，作为 ICMP 报文的数据字段。再加上相应的 ICMP 差错报告报文的前 8个字节，就构成了 ICMP 差错报告报文。提取收到的数据报的数据字段前 8 个字节是为了得到运输层的端口号以及运输层报文的发送序号，这些信息对源点通知高层协议是有用的。

### ICMP 询问报文类型：

（1）回送请求或回送回答：ICMP 回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。// ping

（2）时间戳请求或时间截回答：在 ICMP 时间截请求报文发出后，就能够收到对方响应的 ICMP 时间戳回答报文。利用在报文中记录的时间戳（如报文的发送时间和接收时间），发送方很容易计算出当前网络的往返时延。

# ICMP 的应用：
### ping命令
ICMP 的一个重要应用就是分组网间探测 PING（Packet InterNet Groper），用来测试两台主机之间的连通性。PING 使用了 ICMP 回送请求与回送回答报文。PING 是应用层直接使用网络层ICMP 的一个例子，它没有通过运输层的 TCP 或 UDP。由于往返的 ICMP 报文上都有时间戳，因此很容易得出往返时间。最后显示出的是统计结果：发送到哪个机器（IP 地址），发送的、收到的和丢失的分组数（但不给出分组丢失的原因），以及往返时间的最小值、最大值和平均值


### traceroute / tracert 命令：
tracert 从源主机向目的主机发送一连串的 IP 数据报，数据报中封装的是无法交付的 UDP 用户数据报。//无法交付的UDP用户数据报使用了非法的端口号

1. 第一个数据报 IP 的生存时间 TTL 设置为 1。当 P1 到达路径上的第一个路由器 R1 时，路由器 R1 先收下它，接着把 TTL 的值减 1。由于 TTL 等于零了，因此 R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文。

2. 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达路由器 R1，R1 收下后把 TTL 减 1 再转发给路由器 R2。R2 收到 P2 时 TTL 为 1，但减 1 后 TTL 变为零了。R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报告报文。

3. 这样一直继续下去。当最后一个数据报刚刚到达目的主机时，数据报的 TTL 是 1。主机不转发数据报，也不把 TTL 值减 1。但因 IP 数据报中封装的是无法交付的运输层的 UDP 用户数据报，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。

这样，源主机达到了自己的目的，因为这些路由器和最后目的主机发来的 ICMP 报文正好给出了源主机想知道的路由信息：到达目的主机所经过的路由器的 IP 地址，以及到达其中的每一个路由器的往返时间。
