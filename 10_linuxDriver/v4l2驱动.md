# V4L2

V4L2框架的核心目标是：为不同硬件的Camera设备（如Sensor、ISP、马达）提供统一的用户空间接口，同时简化内核驱动的开发流程

# 关键结构体
## 1. video_device
一个/dev/videoX 对应一个 video_device
```c++
struct video_device {
const struct v4l2_file_operations *fops;    // 用户空间文件操作函数集（open/read/ioctl等）
struct device dev;                          // 设备模型节点，关联到Linux设备树
int minor;                                  // 次设备号（主设备号固定为81，次设备号区分不同设备）
u32 capabilities;                           // 设备能力标识（如V4L2_CAP_VIDEO_CAPTURE表示支持视频采集）
const struct v4l2_ioctl_ops *ioctl_ops;     // ioctl命令处理函数集（核心控制接口）
struct v4l2_device *v4l2_dev;               // 关联的v4l2_device（所属的设备集合）
char name[32];                              // 设备名称（如“my_camera”）
// 其他辅助成员（如缓冲区管理、状态标记等）
};
```
fops：对接用户空间的文件操作
capabilities：告诉应用层设备支持的功能（如是否支持视频采集、流媒体）；
ioctl_ops：处理应用层的控制命令（如调整分辨率、帧率）。


## 2. v4l2_device
代表一个完整的视频设备集合（可能包含多个子设备，如Sensor+ISP+马达）。
```c++
struct v4l2_device {
struct device *dev;                          // 关联的父设备（如平台设备）
struct list_head subdevs;                    // 子设备链表头（管理所有v4l2_subdev）
struct mutex mutex;                          // 互斥锁（保护子设备链表和资源访问）
struct list_head fds;                        // 打开该设备的文件描述符链表
struct v4l2_ctrl_handler *ctrl_handler;      // 全局参数控制中心（如分辨率、曝光、白平衡）
const struct v4l2_device_ops *ops;           // 设备级操作函数集（如子设备通知回调）
char name[V4L2_DEVICE_NAME_SIZE];            // 设备集合名称（如“camera_system”）
// 其他辅助成员
};
```
subdevs：通过链表管理所有子设备（如Sensor子设备、ISP子设备），方便遍历和调用；
mutex：保证多线程/多进程访问设备时的安全性；
ctrl_handler：统一管理设备的控制参数（避免每个子设备重复实现参数逻辑）。

## 3. v4l2_subdev
代表Camera系统中的单个硬件组件（如Sensor、ISP、音圈马达）。
```c++
struct v4l2_subdev {
struct list_head list;                       // 链表节点（用于加入v4l2_device的subdevs链表）
struct device *dev;                          // 子设备的设备模型节点
struct v4l2_device *v4l2_dev;                // 所属的v4l2_device（关联到设备集合）
const struct v4l2_subdev_ops *ops;           // 子设备操作函数集（硬件控制核心）
const char *name;                            // 子设备名称（如“ov5640_sensor”“isp_core”）
struct v4l2_ctrl_handler *ctrl_handler;      // 子设备私有参数控制（如Sensor的增益调节）
// 其他辅助成员（如子设备类型、状态标记）
};
```
list：将子设备挂载到 v4l2_device 的链表中，实现统一管理；
ops：包含子设备的具体控制逻辑（如启动视频流、调整亮度）；
v4l2_dev：明确子设备的归属，确保控制命令能正确传递。