# EGL
EGL 是渲染 API（如 OpenGL ES）和原生窗口系统之间的接口。通常来说，OpenGL 是一个操作 GPU 的 API，它通过驱动向 GPU 发送相关指令，控制图形渲染管线状态机的运行状态，但是当涉及到与本地窗口系统进行交互时，就需要这么一个中间层，因此 EGL 被设计出来，作为 OpenGL 和原生窗口系统之间的桥梁,且它与平台无关的。
在不同平台上有不同的机制以关联窗口系统，在 Windows 上是 WGL ，在 Linux 上是 GLX ，在 Apple OS 上是 AGL 等。EGL 则是平台上 WGL / GLX / AGL的等价物。EGL 假设 OS 会提供窗口系统，但 EGL 与平台无关，并不局限于任何特定的窗口系统，所有用到本地窗口系统的地方都用屏蔽指针来处理,这就是易于移植的关键。
EGL API 是独立于 OpenGL ES 各版本标准的独立的一套 API，其主要作用是为 OpenGL ES 指令 创建 Context 、绘制目标 Surface 、配置 FrameBuffer 属性、Swap 提交绘制结果 。

## EGL 绘图步骤

1. 获取 EGL Display 对象：eglGetDisplay()
2. 初始化与 EGLDisplay 之间的连接：eglInitialize()
3. 获取 EGLConfig 对象：eglChooseConfig()
4. 创建 EGLContext 实例：eglCreateContext()
5. 创建 EGLSurface 实例：eglCreateWindowSurface()
6. 连接 EGLContext 和 EGLSurface：eglMakeCurrent()
7. 使用 OpenGL ES API 绘制图形：gl_*()
8. 切换 front buffer 和 back buffer 送显：eglSwapBuffer()
9. 断开并释放与 EGLSurface 关联的 EGLContext 对象：eglRelease()
10. 删除 EGLSurface 对象
11. 删除 EGLContext 对象
12. 终止与 EGLDisplay 之间的连接

# EGL的绘图
EGLNativeDisplayType – 系统显示类型，标识你所开发设备的物理屏幕，DX/OPenGL ES/Metal/Vulkan….
EGLNativeWindowType – 系统窗口，渲染显示的窗口句柄
EGLDisplay – 关联 EGLNativeDisplayType 系统物理屏幕的通用数据类型，是平台上 WGL / GLX / AGL 的等价物
EGLSurface – 渲染区域，系统窗口或 frame buffer 句柄 ，可以理解为一个后端的渲染目标窗口
EGLConfig – 对 EGLSurface的 EGL 配置，可以理解为绘制目标 framebuffer 的配置属性
EGLContext – OpenGL ES 图形上下文


**EGLSurface 一共分为三类**：
```
1.Surface – 可显示的 Surface，实际上就是一个FrameBuffer，用于绑定窗口后预览显示，通过 eglCreateWindowSurface 创建；
2.PixmapSurface – 不是可显示的 Surface，保存在系统内存中的位图；
3.PBufferSurface – 不是可显示的 Surface，保存在显存中的帧，用于离屏渲染，不需要绑定窗口，通过 eglCreatePbufferSurface 创建
```

**关于多个 EGLContext**:
```
不能在 2 个线程里绑定同一个 EGLContext 。
不能在 2 个不同的线程里，绑定相同的 EGLSurface 到 2 个不同的 EGLContext 上。
在 2 个不同的线程里，绑定 2 个不同 EGLSurface 到 2 个 EGLContext 上，取决于使用的GPU的具体实现，可能成功，也可能失败。
```
# EGL的API

## eglGetDisplay

```c++
/* 描述：获取 EGLDisplay 对象 显示设备
 * 参数：
 *   displayId：系统显示类型
 *
 * 返回值：成功返回 EGLDisplay 对象，失败返回 EGL_NO_DISPLAY
 */
 EGLDisplay eglGetDisplay(EGLNativeDisplayType displayId);

```

获取默认窗口
EGLDisplay eglDisplay = eglGetDisplay(EGL_DEFAULT_DISPLAY);    //两种写法任选其一，效果等价
EGLDisplay eglDisplay = eglGetDisplay(0);                      //两种写法任选其一，效果等价

## eglInitialize
```c++
/* 描述：初始化 EGL
  * 参数：
  *  dpy：系统显示类型,EGLDisplay 对象
  *  major：返回 EGL 主版本号，如果不关心版本号可以直接设置为 NULL
  *  minor：返回 EGL 次版本号，如果不关心版本号可以直接设置为 NULL
  *
  * 返回值：成功返回 TRUE，失败返回 FALSE
  */
EGLBoolean eglInitialize (EGLDisplay dpy, EGLint *major, EGLint *minor);
```

## eglGetConfigs
```c++
/* 描述：
 * 参数：
 *      dpy：系统显示类型,EGLDisplay 对象
 *      configs：输出参数，包含当前系统上所有有效的 EGLConfig 配置列表
 *      config_size：当前系统上所有有效的 EGLConfig 配置列表个数
 *      num_config：实际返回的 GLConfig 个数
 *
 * 返回值：返回值：成功返回 TRUE，失败返回 FALSE
 */
 EGLBoolean eglGetConfigs (EGLDisplay dpy, 
                      EGLConfig *configs,
                      EGLint config_size, 
                      EGLint *num_config);
```
## eglChooseConfig
```c++
/* 描述：配置列表，用于后面创建 EGLSurface
 * 参数：
 *     dpy：系统显示类型,EGLDisplay 对象
 *     attr_list：你想要的属性事先定义到这个数组里
 *     config：图形系统将返回若干满足条件的配置到该数组
 *     config_size：想要选中符合的config的最大个数
 *     num_config：图形系统返回的可用的配置个数
 
 * 返回值：成功返回 TRUE，失败返回 FALSE
*/ 
EGLboolean eglChooseConfig(EGLDisplay dpy,
                     const EGLint * attr_list,
                     EGLConfig * config,
                     EGLint config_size,
                     EGLint *num_config)
```

## eglGetError
```c++
// 描述：返回 EGL 错误号，如果返回 EGL_SUCCESS 说明没有错误
EGLint eglGetError();
```

## eglCreateContext
```c++
/*描述：创建 OpenGL ES 上下文 EGLContext
 *参数：
 *    display：指定显示的连接
 *    config：配置 EGLConfig
 *    share_context：允许其它 EGLContext 共享数据，使用 EGL_NO_CONTEXT 表示不共享
 *    attribList：指定操作的属性列表，只能接受一个属性 EGL_CONTEXT_CLIENT_VERSION（设置 OpenGL ES 版本）
 *
 *返回值：成功时返回新创建的 EGLContext，失败时返回 EGL_NO_CONTEXT
 */
EGLAPI EGLContext EGLAPIENTRY eglCreateContext(
                EGLDisplay display, 
                EGLConfig config,
                EGLContext share_context,
                const EGLint *attribList);
```
```c++
//opengles 3.2 
EGLint contextAttribs[] = {EGL_CONTEXT_MAJOR_VERSION_KHR, 3, EGL_CONTEXT_MINOR_VERSION_KHR, 2, EGL_NONE };
```

## eglCreateWindowSurface
EGLSurface 也称为渲染区域，相当于 OpenGLES 绘图的画布 （一块内存空间），用户想绘制的信息首先都要先绘制到 EGLSurface 上，然后通过 EGLDisplay 显示；
```c++
/*描述：创建 OpenGL ES EGLSurface
 *参数：
 *    display：指定显示的连接
 *    config：配置 EGLConfig
 *    native_window：原生窗口
 *    attribList：指定操作的属性列表 
 *
 *返回值：成功时返回新创建的 EGLSurface，失败时返回EGL_NO_SURFACE.
 */
EGLSurface eglCreateWindowSurface(  
  EGLDisplay display,        
   EGLConfig config,        
   NativeWindowType native_window,
   EGLint const * attrib_list);
```

## eglCreatePbufferSurface
```c++
EGLSurface eglCreatePbufferSurface(
  EGLDisplay display,     // 指定EGL显示连接
        EGLConfig config,     // 指定配置
        const EGLint *attribList)       // 指定像素缓冲区属性
/*
attribList的属性可以是：
EGL_HEIGHT：默认值为0。
EGL_LARGEST_PBUFFER：默认值为EGL_FALSE。
EGL_MIPMAP_TEXTURE：默认值为EGL_FALSE。
EGL_TEXTURE_FORMAT：默认值为EGL_NO_TEXTURE，还可以选择EGL_TEXTURE_RGB或>EGL_TEXTURE_RGBA。
EGL_TEXTURE_TARGET：默认值为EGL_NO_TEXTURE，还可以选择EGL_TEXTURE_2D。
EGL_VG_ALPHA_FORMAT：只适用于OpenVG，默认值为EGL_VG_ALPHA_FORMAT_NONPRE，>还可以选择EGL_VG_ALPHA_FORMAT_PRE。
EGL_VG_COLORSPACE：只适用于OpenVG，默认值为EGL_VG_COLORSPACE_sRGB，还可以选>择EGL_VG_COLORSPACE_LINEAR。
EGL_WIDTH：默认值为0。
*/
```
eglCreatePbufferSurface和eglCreateWindowSurface区别:
PBufferSurface 用于离屏渲染

## eglMakeCurrent
创建了 EGLSurface 和 EGLContext 之后，因为可能有多个 EGLSurface 和EGLContext ，所以需要通过 eglMakeCurrent 绑定 EGLSurface 来指定当前上下文
```c++
/*描述：创建 OpenGL ES EGLSurface
 *参数：
 *    display：指定显示的连接
 *    draw：EGL 绘图表面
 *    read：EGL 绘图表面
 *    context：通过 eglCreateContext 创建的上下文
 *
 *返回值：成功是返回 EGL_TRUE，失败时返回 EGL_FALSE
 */
EGLAPI EGLBoolean EGLAPIENTRY eglMakeCurrent(
          EGLDisplay display, 
                EGLSurface draw,
                EGLSurface read, 
                EGLContext context);
```

## eglSwapBuffer
EGLSurface 作为内存中的画布(不可见)，EGLDisplay 作为显示器输出显示(可见)，而 eglSwapBuffer 作用就是把内存 EGLSurface 中画布中的数据交换到 EGLDisplay ，输出到屏幕显示绘制的内容
```c++
/*描述：把内存 EGLSurface 中画布中的数据交换到 EGLDisplay ，输出到屏幕显示绘制的内容
 *参数：
 *    display：指定显示的连接
 *    surface：EGL 绘图表面
 *
 *返回值：成功是返回 EGL_TRUE，失败时返回 EGL_FALSE
 */
EGLBoolean eglSwapBuffers(EGLDisplay display, EGLSurface surface);
```

## eglDestroySurface
eglDestroySurface 用于销毁渲染 EGLSurface（内存画布），如果有其它线程使用这个 EGLSurface 时就要等到不使用时再销毁，否则立即销毁；
```c++
/*描述：用于销毁渲染 EGLSurface
 *参数：
 *    display：指定显示的连接
 *    context：EGLContext 上下文
 *
 *返回值：成功是返回 EGL_TRUE，失败时返回 EGL_FALSE
 */
EGLAPI EGLBoolean eglDestroySurface(EGLDisplay display, EGLSurface surface);
```

## eglDestroyContext
eglDestroyContext 用于销毁渲染 Context 上下文，如果有其它线程使用这个 Context 上下文时就要等到不使用时再销毁，否则立即销毁；
```c++
/*描述：用于销毁渲染 EGLContext
 *参数：
 *    display：指定显示的连接
 *    context：EGLContext 上下文
 *
 *返回值：成功是返回 EGL_TRUE，失败时返回 EGL_FALSE
 */
EGLAPI EGLBoolean eglDestroyContext(EGLDisplay display, EGLContext context);
```
## eglQueryContext
eglQueryContext 用于查询渲染上下文相关信息
```c++
/*描述：用于查询渲染上下文相关信息
 *参数：
 *    display：指定显示的连接
 *    context：EGLContext 上下文
 *    attribute：查询渲染上下文相关信息 EGL_CONFIG_ID、EGL_CONTEXT_CLIENT_TYPE、EGL_CONTEXT_CLIENT_VERSION
*     value：（输出参数）返回查询结果
 *返回值：成功是返回 EGL_TRUE，失败时返回 EGL_FALSE
 */
EGLBoolean eglQueryContext(  EGLDisplay display, EGLContext context, 
        EGLint attribute, EGLint * value);
```